String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});function DataX(){"undefined"===typeof window.dataX&&(this.locale="eng",this.getByAttr="querySelectorAll"in document?this.getByAttrQS:this.getByAttrFB,this.queueSet=[],this.isReady=!1,this.ids={},this.refId=0,this.refCleanupTimeout=null,this.refCleanupRate=1E3,this.inst=[],this.readyQueue=[],this.lang={},window.dataX=this)}
DataX.prototype.dot=function(a,b){b=!0===b||1===b;var d=a.split("."),c=d.length-1,e=null,f=null;if(0===c)e=window,f=d[0];else{e=window[d[0]];f=d[c];b&&"undefined"===typeof e&&(e=window[d[0]]={});for(var h=1;h<c;h++)e=e[d[h]],b&&"undefined"===typeof e&&(e=e[d[h]]={})}b&&"undefined"===typeof e[f]&&(e[f]={});return{obj:e,key:f}};DataX.prototype.enter=function(a){a=a||window.event;return 13===(a.charCode?a.charCode:a.keyCode)?!0:!1};
DataX.prototype.set=function(a,b,d,c){if("undefined"!==typeof b)try{var e=-1===a.indexOf(".")?"window."+a:a,f=this.dot(e,!0);f.obj[f.key]=b}catch(h){console.log("Error setting value."+h)}if(c||this.isReady)if(b=this.getByAttr(document,'[data-x-bindto="'+a+'"]'),"undefined"===typeof b||0===b.length)console.log("no binds for "+a);else for(a=0,c=b.length;a<c;a++){if(e=b[a],e!==d){var g=e.getAttribute("data-x-bindfn");if(-1!==g.indexOf("_view_"))var m=e.getAttribute("data-x-id"),g=g.replace("_view_",
m);else m=null;f=this.dot(g);"undefined"===typeof f.obj[f.key]?console.log(g+" does not exist"):(console.log("bindfn="+g),f=f.obj[f.key](),g=this.createElement(f),null!==m&&g.setAttribute("data-x-id",m),e.hasAttribute("data-x-render")?(f=e.getAttribute("data-x-render"),f=this.dot(f),f.obj[f.key](e,g)):e.parentNode.replaceChild(g,e))}}else this.queueSet.push([a,b,d])};
DataX.prototype.setItem=function(a,b,d){var c=this.dot(a);b=b.toString();"undefined"!==typeof d&&(c.obj[c.key][b]=d);a=this.getByAttr(document,'[data-x-bindto="'+a+'"]');d=a.length;for(c=0;c<d;c++){for(var e=a[c],f=null,h=e.childNodes,g=0,m=h.length;g<m;g++){var l=h[g];if(1===l.nodeType&&l.hasAttribute("data-x-index")&&l.getAttribute("data-x-index")===b){f=l;break}}null!==f&&(f=e.getAttribute("data-x-bindfn"),f=this.dot(f),f=f.obj[f.key](b).trim(),f=this.createElement(f),e.replaceChild(f,l))}};
DataX.prototype.getParent=function(a,b,d){for(b=!0!==d?b.toUpperCase():b;(a=a.parentElement)&&a.tagName!==b;);return a.tagName===b?a:null};DataX.prototype.childOf=function(a,b){for(;(a=a.parentNode)&&a!==b;);return!!a};DataX.prototype.getTarget=function(a){a||(a=window.event);a=a.target?a.target:a.srcElement;3==a.nodeType&&(a=a.parentNode);return a};DataX.prototype.getByAttrQS=function(a,b){return a.querySelectorAll(b)};
DataX.prototype.getByAttrFB=function(a,b){var d=b.indexOf("["),c=b.indexOf("]",d),e=0===d?"*":b.substring(0,d),f=b.indexOf("=");if(-1<f){var d=b.substring(d+1,f),h=b.substring(f+1,c),c=h.charAt(0);if('"'===c||"'"===c)h=h.substring(1,h.length-1)}else d=b.substring(d+1,c);for(var c=[],e=a.getElementsByTagName(e),g=0,m=e.length;g<m;g++){var l=e[g].getAttribute(d);null!==l&&""!==l&&(-1!==f&&l!=h||c.push(e[g]))}return c};
DataX.prototype.getFirstTag=function(a){for(a=a.firstChild;1!=a.nodeType;)a=a.nextSibling;return a};DataX.prototype.createElement=function(a){var b=document.createElement("div");b.innerHTML=a;return b.firstChild};
DataX.prototype.afterParse=function(){if(0!==this.parsing&&this.parseWait++<this.parseWaitMax)console.log(this.parsing),this.parseWait++,setTimeout(afterParse,10);else if(this.parseWait>=this.parseWaitMax)console.log("waited too long for parse source to load");else{for(var a=document.querySelectorAll("[data-x-ctrl]"),b=0,d=a.length;b<d;b++){var c=a[b],e=c.getAttribute("data-x-ctrl"),f=c.hasAttribute("data-x-view")?c.getAttribute("data-x-view"):c.getAttribute("data-x-viewtype"),h=this.dot(f),h=h.obj[h.key];
if(""===e||"null"===e)g=null;else{var g=this.dot(e),g=g.obj[g.key];g&&(g._ctrl_=e)}var m=c.hasAttribute("id")?c.getAttribute("id"):c.tagName;""===e&&(e="null");e="new "+f+'("'+m+'", '+e+", true) ";try{var l=new h(c,g,!0);console.log(e+l.id)}catch(n){console.log("ERROR: "+e),console.log(n)}}for(b=0;b<this.queueSet.length;b++)a=this.queueSet[b],this.set(a[0],a[1],a[2],!0);this.queue=[];this.isReady=!0}};
DataX.prototype.init=function(){this.parsing=0;"undefined"!==typeof this.parse&&this.parse.init();this.parseWaitMax=1E3;this.parseWait=0;this.afterParse();for(var a=0,b=this.readyQueue.length;a<b;a++)this.readyQueue[a]();this.readyQueue=""};DataX.prototype.htmlEncode=function(a){var b={"&":"&amp;","'":"&#39;",'"':"&quot;","<":"&lt;",">":"&gt;"};return(a+"").replace(/[&"'\<\>]/g,function(a){return b[a]})};
DataX.prototype.htmlDecode=function(a){var b=b={amp:"&","#39":"'",quot:'"',lt:"<",gt:">"};return(a+"").replace(/&(amp|quot|lt|gt|(#)([0-9]*));/g,function(a,c,e,f){return"#"===e?String.fromCharCode(Number(f)):b[c]})};DataX.prototype.namespace=function(a,b){for(var d=window,c=a.split("."),e=c.length-1,f=0;f<e;f++)var h=c[f],d=h in d?d[h]:d[h]={};d[c[f]]="undefined"!==typeof b?b:{}};DataX.prototype.ref=function(a){var b="R"+this.refId++ +"_";this.ids[b]=a;return"dataX.ids."+b};
DataX.prototype.refCleanup=function(){null===this.refCleanupTimeout&&(this.refCleanupTimeout=setTimeout(this.refCleanupNow,this.refCleanupRate))};DataX.prototype.refCleanupNow=function(){clearTimeout(this.refCleanupTimeout);var a={};document.documentElement.innerHTML.replace(/dataX\.ids\.(R[0-9]*_)/g,function(b,d){a[d]=this.ids[d]});this.ids=a;this.refCleanupTimeout=null};DataX.prototype.item=function(a){return a.replace(/\[([0-9]*)\]/g,".$1")};
DataX.prototype.instance=function(a){this.inst.push(a);return"dataX.inst."+(this.inst.length-1)};DataX.prototype.loadLanguage=function(a,b){if("undefined"!==typeof this.lang[a]){var d=this.lang[a];for(locale in d)if("undefined"===typeof b[locale])b[locale]=d[locale];else for(key in d[locale])b[locale][key]=d[locale][key]}};
DataX.setLocale=function(a){this.locale=a;for(var b=this.getByAttr(document,"[data-x-id]"),d=0,c=b.length;d<c;d++){var e=b[d],f=e.getAttribute("data-x-id");console.log("refId="+f);f=this.dot(f);f=f.obj[f.key];e=this.getByAttr(e,"[data-x-msg]");j=0;for(jlen=e.length;j<jlen;j++)for(var h=e[j].getAttribute("data-x-msg").split(","),g=0,m=h.length;g<m;g++){var l=h[g].split(":");2===l.length?e[j].innerHTML=f.content(a,l[0],l[1]):3===l.length&&e[j].setAttribute(l[1],f.content(a,l[0],l[2]))}}};
DataX.prototype.ready=function(a){"function"!==typeof a?console.error('dataX.ready: Expected type "function" and instead recieved type "'+typeof a+'".'):this.readyQueue.push(a)};DataX.prototype.outerHTML=function(a){if(a.outerHTML)return a.outerHTML;"undefined"===typeof this.xser&&(this.xser=new XMLSerializer);return this.xser.serializeToString(a).replace(/ xmlns="[^"]*"/,"")};
DataX.prototype.getData=function(a,b){if(this.isArray(b)){var d=b;b={};for(var c=d.length;c--;)b[d[c]]=""}d={};for(k in b)c=a.hasAttribute(k)?a.getAttribute(k):b[k],k=k.substr(5).replace(/-(.)/g,function(a,b){return b.toUpperCase()}),d[k]=c;return d};DataX.prototype.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)};DataXException=function(a){return{message:a,type:"XO Exception"}};DataXException.prototype.toString=function(){return this.type+": "+this.message};new DataX;function ParseDataX(){}ParseDataX.prototype.toCommentScript=function(a){return"undefined"===typeof a?"":"\x3c!--? "+a.replace(/--/g,"-\\-")+" ?--\x3e"};ParseDataX.prototype.init=function(){this.parseViews(document)};ParseDataX.prototype.jsStr=function(a){return a.replace(/['\n\r\\]/g,function(a){return"\n"===a?"\\n":"\r"===a?"\\r":"\\"+a})};
ParseDataX.prototype.findOrphans=function(a){var b=0;a=dataX.getByAttr(a,"[data-x-bind]");dataX.namespace("app._orphan",{});for(var d=a.length-1;-1<d;d--){var c=a[d];console.log(c);c.setAttribute("data-x-view","app._orphan.view_"+b++);c.setAttribute("data-x-ctrl","");new ViewBuilder(c)}};
ParseDataX.prototype.parseViews=function(a){for(var b=dataX.getByAttr(a,"[data-x-view]"),d=b.length-1;-1<d;d--)new ViewBuilder(b[d]);a.getAttribute?(b=a.getAttribute("data-x-view"),null!==b&&""!==b?new ViewBuilder(a):this.findOrphans(a)):this.findOrphans(a)};
ParseDataX.prototype.parseMsg=function(a){var b=0,d=[];a=a.replace(/\\*\{\{(?:[^}\\]*|\\.)*\}\}/g,function(a){var e=0;if("\\"===a.charAt(0)){for(var f=!0,e=1;"\\"===a.charAt(e++);)f=!f;if(f)return a}a=a.replace(/\\}/g,"}");d.push("("+a.substring(e+2,a.length-2)+")");return"{"+b++ +"}"});return{text:a,vars:d}};
ParseDataX.prototype.commentScript=function(a,b){a=a.replace(/data-el-/g,"");a=a.replace(/data-x-checked="([\s\S]*?)"/g,"$1");return a=a.replace(/\\*\x3c!--\?(?:[\s\S]*?)\?--\x3e|\\*\{\{(?:[^}\\]*|\\.)*\}\}/g,function(a,c,e){c=0;if("\\"===a.charAt(0)){e=!0;for(c=1;"\\"===a.charAt(c++);)e=!e;if(e)return a}if("{"===a.charAt(c))return a=a.replace(/\\}/g,"}"),a=a.substring(c+2,a.length-2),"#"===a.charAt(0)?"<?"+a+"?>":"VAR:"===a.substr(0,4)?(a=parseInt(a.substr(4)),"<?=this.vars["+a+"]=dataX.ref(["+b.vars[a].join(",")+
"]).split('.')[2]?>"):"<?="+dataX.htmlDecode(a)+"?>";a=a.substring(c+5,a.length-4);return"<?"+a.replace(/-\\-/g,"--")+"?>"})};
ParseDataX.prototype.tmpl=function(a,b){var d=0,c="\n",c=c+"\tif (typeof this.controller !== 'undefined') {var _ctrl_ = this.controller;}\n",c=c+"\tvar RET = '",e=this;a.replace(/<\?([\s\S]*?)\?>/g,function(b,f,m){var l=a.slice(d,m);""!=l&&(c+=e.jsStr(l));switch(f.charAt(0)){case "=":c="="===f.charAt(1)?c+("' + dataX.htmlEncode("+f.slice(2)+") + '"):c+("' + ("+f.slice(1)+") + '");break;case "#":c+="' + dataX.ref("+f.substr(1)+") + '";break;default:c+="';"+f+";RET += '"}d=m+b.length});var f=a.slice(d);
0<f.length&&(c+=e.jsStr(f));c+="';\n;";c+="if (typeof _ctrl_ !== 'undefined') {\n";c+="\t;RET = RET.replace(/_ctrl_/g, _ctrl_._ctrl_);\n";c+="}\n";return c+="return RET;"};ParseDataX.prototype.tplFn=function(a){return a.toString().replace(/^function[^\{]*\{([\s\S]*)}$/,"$1")};ParseDataX.prototype.setTPL=function(a,b){var d=[];for(k in a)d.push(k);d="TPL_("+d.join("|")+")";return b.replace(new RegExp(d,"g"),function(b,d){for(k in a)if(d===k)return a[k];return d})};
function adler32(a){for(var b=0,d=1,c=0,e=a.length;b<e;)d+=a.charCodeAt(b++),c+=d;return c%65521<<16|d%65521}"undefined"===typeof dataX?console.error("Include dataX.js before dataX.parse."):dataX.parse=new ParseDataX;
//parse.parseView = function(el);
//var dataX = window.dataX;
//var parse = dataX.parse;
function ViewBuilder(el) {
	this.el = el;

	//The generated source will replace TPL_{vars.key} with the value of vars[key]
	var TPL_vars = {
		bindMethods: null,
		namespace: null,
		render: null,
		msg: null
	};

	this.namespace = TPL_vars.namespace=el.getAttribute('data-x-view');
	this.bindSrc = []; // Source code to be attached to the document.
	this.bindId = 0; // An id number for unique bind functions in this view class.
	this.msg = {}; // A text dictionary for translations.

	//.vars - array to hold preprocessing vars for substition
	// ${VAR:n} will be replaced with contents of .vars[n]
	this.vars = [];
	this.parseAttrs(); // Parse data-x attributes and data-x-bind functions.

	TPL_vars.bindMethods = this.bindSrc.join('\n\n') + "\n\n";
	var src = el.innerHTML;
	el.innerHTML = ""; // clear for doc view

	try {
		src = dataX.parse.commentScript(src, this); // Parse bind language to <?...?> for tmpl parser
	} catch (err) {
		console.log("View '" + this.namespace + "': Error parsing view render.\n\n" + src);
		throw(err);
	}

	try {
		TPL_vars.render = dataX.parse.tmpl(src, this.namespace); // Parse <?..?> to javascript
	} catch (err) {
		console.log("View '" + this.namespace + "': Error parsing template. \n\n" + src);
		throw(err);
	}

	var fn = null;

	TPL_vars.msg=JSON.stringify(this.msg);
	// bindMethods, render, namespace, msg

	src = dataX.parse.setTPL(TPL_vars, ViewBuilder.viewTemplate);

	console.log(src);

	try {
		dataX.parsing++;
		var script = document.createElement("script");
		script.type="text/javascript";
		try {
			script.appendChild(document.createTextNode(src+'\ndataX.parsing--'));
		} catch (e) {
			script.text = src+'\ndataX.parsing--';
		}
		document.body.appendChild(script);
	} catch (err) {
		console.log('Error creating view class "' + this.namespace + '". \n\n' + err);
		fn = new Function ("","return 'ERROR';");
	}
}

ViewBuilder.prototype.parseAttrs = function() {
	var baseElement = this.el;
	var nextIter = 0;

	var list = dataX.getByAttr(baseElement, '[data-on-dblclick]');

	for (var i = 0, len = list.length; i < len; i++) {
		var el = list[i];
		var value = el.getAttribute('data-on-dblclick');
		value = "if (dataX.dbl(this)) \{ " + value + "; \}";
		el.setAttribute('data-el-onclick', value); 
	}

	var list = dataX.getByAttr(baseElement, '[data-x-checked]');

	for (var i = 0, len = list.length; i < len; i++) {
		var el = list[i];
		var value = el.getAttribute('data-x-checked');
		value = "{{(" + value + ") ? 'checked=\\'yes\\'' : ''}}";
		el.setAttribute('data-x-checked', value);
	}

	var list = dataX.getByAttr(baseElement, '[data-x-if]');

	for (var i = 0, len = list.length; i < len; i++) {
		var el = list[i];
		var beginIf = "<!--?\n\tif (" + dataX.htmlDecode(el.getAttribute('data-x-if')) + ") { //data-x-if \n\t\t?-->";
		var endIf = "<!--?\n\t}  //end data-x-if \n\n\t?-->";
		el.insertAdjacentHTML('beforebegin', beginIf);
	
		var sib = el;
		var last = el;
	
		while(sib !== null) {

			sib = sib.nextSibling;

			if (sib === null || sib.nodeType !== 1) {
				continue; // only concerned with element nodes
			} else if (sib.hasAttribute('data-x-else')) {
				var elseStr = sib.getAttribute('data-x-else');
				if (elseStr !== "") {
					// todo: clean code for comment script (-- to -\-)
					beginElse = "<!--?\n\t} else if (" + dataX.htmlDecode(elseStr) + ") { // data-x-else \n\t\t?-->";
				} else {
					beginElse = "<!--?\n\t} else { // data-x-else \n\t\t?-->";
				}

				sib.insertAdjacentHTML('beforebegin', beginElse);
				last = sib; // last sibling element
			} else {
				sib = null; // not an else node
			}
		}

		last.insertAdjacentHTML('afterend', endIf);
	}

	var list = dataX.getByAttr(baseElement, 'script[type="text/xo-js"]'); //script[type="text/xo-js"]');

	for (var i = 0, len = list.length; i < len; i++) {
		var el = list[i];
		var source = "<!--?" + el.innerHTML.replace(/--/g,"-\\-") + "?-->";
		el.outerHTML = source;
	}

  // data-x-msg Makes a dictionary entry for key with the value of the innerHTML or attribute.
  // data-x-msgn="key,attribute:key"
  // The parsing process adds a refId for variable substitution
	var list = dataX.getByAttr(baseElement, '[data-x-msg]');
	var origin = dataX.locale;// TODO: dataX.locale should be replaced with module locale.
	if (typeof this.msg[origin] === "undefined") {
		this.msg[origin] = {}; // create dictionary if it doesn't exist.
	}
	for(var i = 0, len=list.length; i < len; i++) {
		var el=list[i];
		var keys = el.getAttribute('data-x-msg').split(',');
		var dataMsg = [];
		for (var j =0, jlen=keys.length; j < jlen; j++) {
			var pair = keys[j].split(':');
			var varIndex = this.vars.length;
			if (pair.length === 1) {// innerHTML
				var key = pair[0];
				var msg = dataX.parse.parseMsg(el.innerHTML);
				var attrName = '';
				el.innerHTML="{{this.content('" + origin + "','" + key + "',this.vars[" + varIndex + "])}}";
			} else if(pair.length === 2) {// attribute:key
				// if data-el-attr exists wrap.. else grab el.attr, wrap and put into data-el-attr
				var elAttr = 'data-el-'+pair[0];
				var key = pair[1];
				var attr = (el.hasAttribute(elAttr)) ? el.getAttribute(elAttr) : el.getAttribute(pair[0]);
				var msg = dataX.parse.parseMsg(attr);
				var attrName = pair[0] + ':';
				attr = "{{this.content('" + origin + "','" + key + "',this.vars[" + varIndex + "])}}"
				el.setAttribute(elAttr,attr);
			}
			if (typeof this.msg[origin][key] !== "undefined") {
				console.log('NOTICE: ' + this.namespace + '.msg["' + key + '"] exists. Key should only be defined once.');
			}
			this.vars[varIndex] = msg.vars;
			this.msg[origin][key]=[adler32(msg.text),msg.text];
			dataMsg.push(key+":" + attrName + "{{VAR:"+varIndex+"}}"); // will parse to  ${this.vars[varIndex]=dataX.ref(ViewClass.vars[varIndex])}
		}
		el.setAttribute("data-x-msg",dataMsg.join(','));
	}

	var list = dataX.getByAttr(baseElement, '[data-x-each]');

	for (var i = 0, len = list.length; i < len; i++) {
		var el = list[i];
		var str = el.getAttribute('data-x-each')
		var parts = str.split(':');
		if (parts.length !== 2) {
			console.log('data-x-each should be arrName:item not "' + str + '"');
			continue; // bad syntax
		}
		var arrName = parts[0];
		var itemName = parts[1];
		parts = dataX.parse.setTPL({
			arr: parts[0],
			item: parts[1],
			name: parts[0].replace(/\./g,"_") // array name for iter and len
		}, ViewBuilder.eachTemplate).split('TPL_SPLIT');
		el.insertAdjacentHTML('afterbegin', dataX.parse.toCommentScript(parts[0]));
		el.insertAdjacentHTML('beforeend', dataX.parse.toCommentScript(parts[1]));
	}

  // data-x-each="arrName:itemName"
  // var arrName_len = arrName.length;
  // var arrName_i = 0;

  var list = dataX.getByAttr(baseElement, '[data-x-js]');

  for (var i = 0, len = list.length; i < len; i++) {
	var el = list[i];
	var js = el.getAttribute('data-x-js'); // htmlDecode?
	// Comments do not allow "--".
	js = js.replace("--", "-\\-"); //.trim();
	var beginJs = "<!--? " + js + " { ?-->";
	var endJs = "<!--? } ?-->";

	// if and else statments surround element.
	if (js.substr(0,2) === 'if') {
	  // insertBefore
	  el.insertAdjacentHTML('beforebegin', beginJs);
	  el.insertAdjacentHTML('afterend', endJs);
	} else if (js.substr(0,4) === 'else') {
	  // Text can not be output between if and else statements.
	  // If the prevous node is a text node clear text.(?non whitespace)
	  if (el.previousSibling.nodeType === 3) { 
		el.previousSibling.nodeValue = "";
	  }
	  el.insertAdjacentHTML('beforebegin', beginJs);
	  el.insertAdjacentHTML('afterend', endJs);
	} else {
	  // for loops put the statement inside of the element.
	  el.insertAdjacentHTML('afterbegin', beginJs);
	  el.insertAdjacentHTML('beforeend',endJs);
	}
  }
  
	// bind elements to variables
	var bindElements = dataX.getByAttr(baseElement, '[data-x-bind]');
	var i = bindElements.length;

	while(i--) {
		this.doBind(bindElements[i], false);
	}

	if (!baseElement.getAttribute) return;
	var baseBind = baseElement.getAttribute('data-x-bind');
	if (baseBind !== "" && baseBind !== null) {
		this.doBind(baseElement, true);
	}
};


ViewBuilder.prototype.doBind = function(el, isBaseElement) {
	var varName = el.getAttribute('data-x-bind');
	if (varName.charAt(0) === '@') {
		this.bindList(varName, el, isBaseElement);
	} else {
		this.bindEl(varName, el, false, isBaseElement);
	}

	el.setAttribute('data-x-isbound', 'yes'); // set an attribute telling wrapping nodes this is bound.
	el.innerHTML = "<!-- bind complete -->"; // remove template contents to prevent wrapping nodes from processing.
};

ViewBuilder.prototype.bindList = function(varName, el, isBaseElement) {
    // @varName:itemName - shorthand bind foreach
    var parts = varName.substring(1).split(':');
    
    if (parts.length !== 2) {
    	console.log('Wrong bind syntax. ' + varName);
    	return;
    }

    // Replacements for TPL_varname, and TPL_itemname.
    var reps = {
      varname: parts[0],
      itemname: parts[1]
    };

    var filter = el.getAttribute('data-x-filter');
    reps.filter = (filter) ? "if(!("+filter+"))continue;" : "";

    // TODO: Explore idea of using a ref for item to allow for changing
    // value of item reference and binding instead of iteration index/key.
    /*
    if (el.hasAttribute('data-x-ref') && el.getAttribute('data-x-ref') === 'true') {
      reps.itemvalue = "dataX.ref(" + reps.itemname + ")"
    } else {
      reps.itemvalue = "'" + reps.varname + "[' + _index_ + ']'"
    }
    */

    var parts = dataX.parse.setTPL(reps, ViewBuilder.bindTemplate).split('TPL_SPLIT');
    el.insertAdjacentHTML('afterbegin', dataX.parse.toCommentScript(parts[0]));
    el.insertAdjacentHTML('beforeend', dataX.parse.toCommentScript(parts[1]));
    this.bindEl(reps.varname, el, true, isBaseElement);
};

ViewBuilder.prototype.bindEl = function(varName, el, hasLoop, isBaseElement) {
  // Should local name default to the last name from namespace.something.varName?
  var localName = null; // Local name for global var if exists.
  var sep = varName.indexOf(':'); // Seperator for localName

  // If there is a seperator then extract the localName.
  if (sep > 0) {
      localName = varName.substr(sep + 1);
      varName = varName.substr(0,sep);
  }

  var bindId = this.bindId++;
  var fnStr = this.namespace + ".bind[" + bindId + "]";


  // x-bindto is set in order to use varName:localName and @varName:iterName
  // We only search data-x-bindto for root variable name.
  el.setAttribute('data-x-bindto', varName);

  if (isBaseElement === true) {
  	// bind function is a prototype so it does not exist.
    //el.setAttribute('data-x-bindfn', el.getAttribute('data-x-view') + '.bind_' + bindId);
    el.setAttribute('data-x-bindfn', '_view_.bind_' + bindId);
  } else {
    el.setAttribute('data-x-bindfn', "{{this.id}}.bind_" + bindId);
    el.outerHTML = "{{this.bind_" + bindId + "()}}";
  }

  var fnsrc = el.outerHTML;
  var id = el.getAttribute('id');
  var src  = "";
  src = dataX.parse.commentScript(fnsrc, this); // Parse bind language to <?...?> for tmpl parser      
  src = dataX.parse.tmpl(src, id); // Parse <?..?> to javascript

  if (localName !== null) {
    src = "var " + localName + " = " + varName + ";\n" + src;
  }

  var srcHeader =  this.namespace + ".prototype.bind_" + bindId + " = function(";
  srcHeader += (hasLoop === true) ? "_index_" : "";
  srcHeader += "){\n\t";
  src = srcHeader + src + "\n};";
  this.bindSrc.push(src);
};

/**** TEMPLATES ****/


// A list bind template that allows for setting an index to render
// one item if needed. Also has filter applied in render loop.
ViewBuilder.bindTemplate = dataX.parse.tplFn(function () {
	var _single_ = false;
	var _len_ = 0;
	var _k_;
	var _items_ = TPL_varname;

	if (typeof _index_ !== 'undefined') {
		// Render index.
		RET = '';
		_len_ = parseInt(_index_) + 1;
		_single_ = true;
	} else {
		var _index_ = 0;
		// Render list.
		if( Object.prototype.toString.call(TPL_varname) !== '[object Array]' && TPL_varname !== null) {
			// Not an array and not null, assume it's an object.
    		_items_ = [];
    		// TODO: option to sort object keys.
    		for (_k_ in TPL_varname) _items_.push(_k_);
		}
		_len_ = _items_.length;
	}
	  
	for (_index_; _index_ < _len_; _index_++){
		TPL_filter
		var TPL_itemname = _items_[_index_];
		TPL_SPLIT
	}

	if (_single_ === true) {
		if (typeof _ctrl_ !== 'undefined') {
			return RET.replace(/_ctrl_/g, _ctrl_._ctrl_);
		}
		return RET;
	}
});

ViewBuilder.eachTemplate = dataX.parse.tplFn(function() {
	for (var TPL_item_i=0,TPL_item_len=TPL_arr.length; TPL_item_i < TPL_item_len; TPL_item_i++) {
		var TPL_item = TPL_arr[TPL_item_i];
		TPL_SPLIT
	}
});

// viewSrc - template source code for creating a view class.
// TPL_variables are replaced.
ViewBuilder.viewTemplate = dataX.parse.tplFn(function() {
  /*******************************
  * xo compiled view
  * TPL_namespace 
  *******************************/

  dataX.namespace('TPL_namespace', function(el,controller) {
	this.className = 'TPL_namespace';
	this.id = dataX.ref(this); // TODO: look at changing .id to ._view_ to match ._ctrl_ pattern
	this.vars = []; // a place to hold refIds for language parameters
	this.locale=dataX.locale;
	var self = this;

	if (typeof el !== "undefined" && el !== null) {
	  this.el = el;
	  el.setAttribute('data-x-id', this.id);
	  this.refresh = function() {self.el.innerHTML=self.render();};
	} else {
	  this.el = null;
	  this.refresh = function() {return self.render();};
	}

	if (typeof controller !== 'undefined' && controller !== null) {
	  this.controller = controller;
	  if (el !== null && typeof controller.onViewInit !== "undefined") {
		controller.onViewInit(this);
	  }
	  /*
		if (el.hasAttribute('data-x-init')) {
		  var d = dataX.dot(el.getAttribute('data-x-init'));
		  d.obj[d.key](this); // TODO: should we do a check for true / false to render the element?
		}
	  */ 
	}
	
	this.refresh();
  });

  /*******************************
  * Bind Methods
  *******************************/

  TPL_bindMethods

  /*******************************
  * Render
  *******************************/

  TPL_namespace.prototype.render = function() {
	TPL_render
  };

  TPL_namespace.prototype.getData = function(defaults) {
	return dataX.getData(this.el, defaults);
  };

  /*******************************
  * Translation 
  *******************************/

  TPL_namespace.prototype.content = function(locale, key, refId) {
	var mylang = this.msg[locale];
	var origin = this.msg[this.locale];
	if(typeof origin === 'undefined') return '?'; // the origin language is not set.
	var reg = /{([0-9]*)}/g;
	var vars = xDoc.ids[refId];
	if (typeof vars === 'undefined') vars = []; // should this throw an error?
	var text = '';

	function replacer(match, $1) {
	  return vars[$1];
	}

	if (typeof mylang==='undefined') {
	  console.log(this.className + '. Locale "' + locale + '" not found.');
	  text = origin[key][1];
	} else if(typeof mylang[key] === 'undefined') {
	  console.log(this.className + '. No translation for "' + locale + '","' + key + ".");
	  text = origin[key][1];
	} else if(mylang[key][0] !== origin[key][0]) {
	  console.log(this.className + '. Checksum missmatch with origin "' + this.locale + '","' + key + '".');
	  text = origin[key][1];
	} else {
	  text = mylang[key][1]
	}

	text = text.replace(/data-el-/g,'');
	if (typeof this.controller !== 'undefined') {
	  text = text.replace(/_ctrl_/g, this.controller._ctrl_);
	}
	// replace variables {0},{1},{2}, etc. if exists
	if (typeof vars !== 'undefined' && vars.length > 0) {
	  return text.replace(reg, replacer);
	}
	return text;
  };

  TPL_namespace.prototype.msg = TPL_msg;
  // Load any languages that were set prior to class creation.
  dataX.loadLanguage('TPL_namespace', TPL_namespace.prototype.msg);
});//@ sourceMappingURL=data-x.min.js.map
